name: Create Release

on:
  workflow_dispatch:
    inputs:
      workflow_id:
        description: 'Build workflow run ID to use for artifacts'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: true
        type: boolean
        default: false
      tag_name:
        description: 'Release tag name (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts from workflow
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow_conclusion: success
          run_id: ${{ github.event.inputs.workflow_id }}
          path: artifacts

      - name: List downloaded artifacts
        run: find artifacts -type f | sort

      - name: Get version number
        id: get_version
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name }}"
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"

      - name: Prepare release assets
        run: |
          mkdir -p release_assets

          # Process Windows x64 artifacts
          if [ -d "artifacts/chatchat-win-x64" ]; then
            cp artifacts/chatchat-win-x64/*.exe release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-win-x64/*.msi release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-win-x64/*.zip release_assets/ 2>/dev/null || true
          fi

          # Process Windows arm64 artifacts
          if [ -d "artifacts/chatchat-win-arm64" ]; then
            cp artifacts/chatchat-win-arm64/*.exe release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-win-arm64/*.msi release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-win-arm64/*.zip release_assets/ 2>/dev/null || true
          fi

          # Process Linux x64 artifacts
          if [ -d "artifacts/chatchat-linux-x64" ]; then
            cp artifacts/chatchat-linux-x64/*.AppImage release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-linux-x64/*.deb release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-linux-x64/*.rpm release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-linux-x64/*.tar.gz release_assets/ 2>/dev/null || true
          fi

          # Process Linux arm64 artifacts
          if [ -d "artifacts/chatchat-linux-arm64" ]; then
            cp artifacts/chatchat-linux-arm64/*.AppImage release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-linux-arm64/*.deb release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-linux-arm64/*.rpm release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-linux-arm64/*.tar.gz release_assets/ 2>/dev/null || true
          fi

          # Process Mac x64 artifacts
          if [ -d "artifacts/chatchat-mac-x64" ]; then
            cp artifacts/chatchat-mac-x64/*.dmg release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-mac-x64/*.zip release_assets/ 2>/dev/null || true
          fi

          # Process Mac arm64 artifacts
          if [ -d "artifacts/chatchat-mac-arm64" ]; then
            cp artifacts/chatchat-mac-arm64/*.dmg release_assets/ 2>/dev/null || true
            cp artifacts/chatchat-mac-arm64/*.zip release_assets/ 2>/dev/null || true
          fi

          ls -la release_assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          name: ChatChat App V${{ steps.get_version.outputs.version }}
          draft: true
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            release_assets/*
          body: |
            # ğŸš€ ChatChat App ${{ steps.get_version.outputs.version }} æ­£å¼å‘å¸ƒ

            ğŸ“¦ **æ„å»ºä¿¡æ¯**
            - Workflow ID: `${{ github.event.inputs.workflow_id }}`
            - ç‰ˆæœ¬: `${{ steps.get_version.outputs.version }}`
            - é¢„å‘å¸ƒ: `${{ github.event.inputs.prerelease }}`
            - æ„å»ºæ—¶é—´: `${{ github.run_id }}`

            ğŸ”¥ **ä¸»è¦ç‰¹æ€§**
            âœ… **å¼ºå¤§çš„AIåŠ©æ‰‹**ï¼šä¸ºç”Ÿäº§è€…æ‰“é€ çš„æ™ºèƒ½å¯¹è¯å·¥å…·
            âœ… **è·¨å¹³å°æ”¯æŒ**ï¼šWindowsã€macOSã€Linux å…¨å¹³å°è¦†ç›–
            âœ… **å¼€ç®±å³ç”¨**ï¼šç®€å•é…ç½®ï¼Œå¿«é€Ÿä¸Šæ‰‹
            âœ… **æŒç»­æ›´æ–°**ï¼šå®šæœŸè¿­ä»£ï¼ŒåŠŸèƒ½ä¸æ–­å®Œå–„

            ğŸ“¥ **ä¸‹è½½è¯´æ˜**
            - Windows: ä¸‹è½½ `.exe` å®‰è£…åŒ…æˆ– `.zip` ä¾¿æºç‰ˆ
            - macOS: ä¸‹è½½ `.dmg` å®‰è£…åŒ…
            - Linux: ä¸‹è½½ `.AppImage`ã€`.deb` æˆ– `.rpm` åŒ…

            ğŸ’¬ **åé¦ˆä¸æ”¯æŒ**
            å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤ Issue æˆ– Pull Requestï¼

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}